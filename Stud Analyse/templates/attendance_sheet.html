<!DOCTYPE html>
<html lang="en">
     {% load static %}
<head>
    <meta charset="UTF-8">
    <title>Attendance Report | View Only</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="{% static 'attendance_sheet.css' %}">
</head>
<body>

    <div class="bg-animation">
        <div class="blob"></div>
        
        <div class="blob"></div>
    </div>

    <div class="attendance-container">
        <header class="table-header">
            <div class="header-left">
                <h1><strong>üìà Attendance Analysis</strong></h1>
                <p id="currentDate"></p>
            </div>
            <div class="summary-box">
                <strong>Class Average: <span id="classAvg">0%</span></strong>
            </div>
        </header>

        <div class="toolbar">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="Search name, roll, or enrollment..." oninput="renderTable()" style="font-weight: bold;">
            </div>
            
            <select id="stdFilter" onchange="renderTable()" style="font-weight: bold;">
                <option value="10">Grade 10</option>
                <option value="11">Grade 11</option>
                <option value="12">Grade 12</option>
            </select>

            <button class="export-btn" onclick="exportToExcel()"><strong>üì• Export Excel</strong></button>
        </div>

        <div class="table-wrapper">
            <table class="attn-table">
                <thead>
                    <tr>
                        <th onclick="toggleSort()"><strong>Roll No ‚áÖ</strong></th>
                        <th><strong>Student Name</strong></th>
                        <th style="text-align: center;"><strong>Current Status</strong></th>
                        <th style="text-align: center;"><strong>Attendance Grade</strong></th>
                    </tr>
                </thead>
                <tbody id="attendanceBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        document.getElementById('currentDate').innerText = new Date().toDateString().toUpperCase();
        
        let students = JSON.parse(localStorage.getItem("activities")) || [];
        let uniqueStudents = Array.from(new Map(students.map(item => [item['enrollmentNo'], item])).values());
        let sortAsc = true;

        function renderTable() {
            const body = document.getElementById('attendanceBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filter = document.getElementById('stdFilter').value;
            body.innerHTML = "";

            let filtered = uniqueStudents.filter(s => 
                (s.studentName.toLowerCase().includes(search) || 
                (s.enrollmentNo && s.enrollmentNo.toString().includes(search)) ||
                (s.rollNo && s.rollNo.toString().includes(search))) &&
                s.std === filter
            );

            let pctSum = 0;

            filtered.forEach(s => {
                const attended = s.attendedCount || 42; 
                const total = s.totalSessions || 60;
                const pct = Math.round((attended / total) * 100);
                pctSum += pct;

                const isPresent = s.status === 'Present';
                const gradeClass = pct < 65 ? 'grade-low' : 'grade-high';

                const row = document.createElement('tr');
                row.className = isPresent ? 'status-p' : 'status-a';
                
                row.innerHTML = `
                    <td class="roll-id"><strong>${s.rollNo || '‚Äî'}</strong></td>
                    <td>
                        <div class="name-text"><strong>${s.studentName.toUpperCase()}</strong></div>
                        <div class="enr-text"><strong>${s.enrollmentNo}</strong></div>
                    </td>
                    <td style="text-align: center;">
                        <span class="badge-fixed"><strong>${(s.status || 'Present').toUpperCase()}</strong></span>
                    </td>
                    <td style="text-align: center;">
                        <div class="grade-box ${gradeClass}">
                            <div class="grade-val"><strong>${pct}%</strong></div>
                            <div class="grade-label"><strong>${pct < 65 ? 'ATTENTION' : 'EXCELLENT'}</strong></div>
                        </div>
                    </td>
                `;
                body.appendChild(row);
            });

            const avg = filtered.length > 0 ? Math.round(pctSum / filtered.length) : 0;
            document.getElementById('classAvg').innerText = avg + "%";
        }

        function toggleSort() {
            sortAsc = !sortAsc;
            uniqueStudents.sort((a, b) => sortAsc ? (a.rollNo - b.rollNo) : (b.rollNo - a.rollNo));
            renderTable();
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(uniqueStudents);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Analysis");
            XLSX.writeFile(wb, "Attendance_Report.xlsx");
        }

        renderTable();
    </script>
</body>
</html>